---
title: "September 2020 Oregon Wildfires"
author: "Eli Grosman, Mazama Science"
date: "September 18, 2020"
output: rmarkdown::html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
At the end of a hot and dry summer, the conditions were set for several large
wildfires to spread across western Oregon. The purpose of this document is to 
demonstrate the **RAWSmet** package's data gathering and modeling capabilities
by investigating the factors that allowed for the wildfires to spread. 

## Assembling data
First, we will use **RAWSmet**'s `wrcc_loadMeta()` and `wrcc_load()` functions 
to gather recent data from all of the stations in Oregon. The following code 
is executed to gather the necessary data between August 31st and September 14th,
approximately a week before and after the start of the wildfires in Holiday Farm.
```{r assembleData, message = FALSE}
library(RAWSmet)

setRawsDataDir("~/Data/RAWS")

oregonMeta <- wrcc_loadMeta(stateCode = "OR")

filePath <- file.path(getRawsDataDir(), "stationList_OR.rda")

if ( file.exists(filePath) ) {
  
  stationList_OR <- get(load(filePath))
  
} else {
  
  stationList_OR <- list()
  counter <- 1
  
  for ( wrccID in oregonMeta$wrccID ) {
    
    message(sprintf("Working on %s (%d/%d)", wrccID, counter, nrow(oregonMeta)))
    
    # Keep going even if a particular station doesn't have data
    res <- try({
      
      stationTimeseriesObject <- 
        wrcc_load(wrccID = wrccID, meta = oregonMeta, year = 2020) %>%
        raws_filterDate(
          startdate = MazamaCoreUtils::parseDatetime(20200831, timezone = "America/Los_Angeles"),
          enddate = MazamaCoreUtils::parseDatetime(20200914, timezone = "America/Los_Angeles"))
      
      stationList_OR[[wrccID]] <- stationTimeseriesObject
    }, silent = TRUE)
    
    counter <- counter + 1
      
  }
  
  save(stationList_OR, file = filePath)
    
}
```

## Locations with data
Across the state of Oregon there are 205 RAWS stations with data provided by the 
WRCC, however, only 134 of these stations have accessible data from the dates of 
the fires. The locations of these stations in addition to station metdata
can be seen on the following map: 
```{r oregonStations, message = FALSE}
wrccIDs <- names(stationList_OR)

meta <- oregonMeta %>% dplyr::filter(wrccID %in% wrccIDs)
RAWSmet::raws_leaflet(meta)
```

## Wind shift maps
With all of the necessary data assembled, we can now take a look at the wind patterns
around the dates of the wildfires. These maps, created with `maps::map()` and 
`RAWSMet::addWindBarbs()`, show the direction and speeds of winds and gusts at 
all of the available stations in Oregon. It is clear that over the dates of the 
fires there are strong winds coming from the east. 
```{r windShift, message = FALSE, echo = FALSE, fig.align = "center", fig.width = 10, fig.height = 10}
library(maps)

par(mfrow = c(2, 2))

maps::map('state', 'oregon', fill = FALSE, col = 'gray80')
title("Sept. 6th at noon")

for ( station in stationList_OR ) {
  data <- 
    station$data %>%
    dplyr::filter(
      datetime == MazamaCoreUtils::parseDatetime(2020090612, timezone = "America/Los_Angeles")
    )
  knots <- data$maxGustSpeed * 1.944
  addWindBarbs(
    station$meta$longitude, 
    station$meta$latitude, 
    knots, 
    data$maxGustDirection,
    circleSize = 0.5,
    circleFill = 'black',
    lineCol = 1,
    extraBarbLength = -0.2,
    lwd = 1.2
  )
}


maps::map('state', 'oregon', fill = FALSE, col = 'gray80')
title("Sept. 6th at midnight")

for ( station in stationList_OR ) {
  data <- 
    station$data %>%
    dplyr::filter(
      datetime == MazamaCoreUtils::parseDatetime(2020090700, timezone = "America/Los_Angeles")
    )
  knots <- data$maxGustSpeed * 1.944
  addWindBarbs(
    station$meta$longitude, 
    station$meta$latitude, 
    knots, 
    data$maxGustDirection,
    circleSize = 0.5,
    circleFill = 'black',
    lineCol = 1,
    extraBarbLength = -0.2,
    lwd = 1.2
  )
}


maps::map('state', 'oregon', fill = FALSE, col = 'gray80')
title("Wind Gusts on Sept. 7th at noon")

for ( station in stationList_OR ) {
  data <- 
    station$data %>%
    dplyr::filter(
      datetime == MazamaCoreUtils::parseDatetime(2020090712, timezone = "America/Los_Angeles")
    )
  knots <- data$maxGustSpeed * 1.944
  addWindBarbs(
    station$meta$longitude, 
    station$meta$latitude, 
    knots, 
    data$maxGustDirection,
    circleSize = 0.5,
    circleFill = 'black',
    lineCol = 1,
    extraBarbLength = -0.2,
    lwd = 1.2
  )
}


maps::map('state', 'oregon', fill = FALSE, col = 'gray80')
title("Wind Gusts on Sept. 7th at midnight")

for ( station in stationList_OR ) {
  data <- 
    station$data %>%
    dplyr::filter(
      datetime == MazamaCoreUtils::parseDatetime(2020090800, timezone = "America/Los_Angeles")
    )
  knots <- data$maxGustSpeed * 1.944
  addWindBarbs(
    station$meta$longitude, 
    station$meta$latitude, 
    knots, 
    data$maxGustDirection,
    circleSize = 0.5,
    circleFill = 'black',
    lineCol = 1,
    extraBarbLength = -0.2,
    lwd = 1.2
  )
}
```

## Wind shift time series plots
Lets take a closer look at some stations west of the cascades. With **RAWSmet**'s
`windTimeseriesPlot()` and `timeseriesMultiplot`, we can see the change in the
wind pattern and the change in temperature and humidity over this time period.
It is apparent that  over labor day weekend, the direction of the wind suddenly 
changed to point east and gust speeds increased considerably. Furthermore, 
these stations experienced an extreme drop in humidity and temperature increased
overall.
```{r windTimeseriesPlots, message = FALSE, echo = FALSE, fig.align = "center", fig.height = 10, fig.width = 10}

# Get data

orOBRR <- 
  wrcc_load(wrccID = "orOBRR", meta = oregonMeta, year = 2020) %>%
  raws_filterDate(20200904, 20200908)

orOGOO <- 
  wrcc_load(wrccID = "orOGOO", meta = oregonMeta, year = 2020) %>%
  raws_filterDate(20200904, 20200908)

orOBRRData <- orOBRR %>% raws_extractData()
orOGOOData <- orOGOO %>% raws_extractData()

# Create plots

orOBRRwindTimeseries <- windTimeseriesPlot(orOBRR)
orOGOOwindTimeseries <- windTimeseriesPlot(orOGOO)

orOBRRtimeseriesMultiplot <-
  timeseriesMultiplot(orOBRRData, pattern = c("humidity|temperature"), nrow = 2) + 
  ggplot2::ggtitle(sprintf("Temperature and Humidity in %s, %s", 
                           orOBRR$meta$wrccID, orOBRR$meta$siteName)) +
  ggplot2::xlab("Time") +
  ggplot2::ylab("Temperature (°C), Humidity (%)") +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

orOGOOtimeseriesMultiplot <-
  timeseriesMultiplot(orOGOOData, pattern = c("humidity|temperature"), nrow = 2) +
  ggplot2::ggtitle(sprintf("Temperature and Humidity in %s, %s", 
                           orOGOO$meta$wrccID, orOGOO$meta$siteName)) +
  ggplot2::xlab("Time") +
  ggplot2::ylab("Temperature (°C), Humidity (%)") +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5))

gridExtra::grid.arrange(orOBRRwindTimeseries, orOGOOwindTimeseries, orOBRRtimeseriesMultiplot, orOGOOtimeseriesMultiplot)
```


## Extra

