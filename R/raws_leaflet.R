#' @export
#' @importFrom leaflet leaflet addProviderTiles addCircleMarkers
#' 
#' @title Create a map of RAWS stations
#' 
#' @param metadata Station metadata created by \code{raws_createMetadata}
#' @param radius Circle radius
#' @param stroke Logical. whether to draw stroke along the path
#' @param color Stroke color
#' @param opacity Stroke opacity
#' @param fillColor Fill color
#' @param fillOpacity Fill opacity
#' @param weight Stroke width in pixels
#' 
#' @return Leaflet map of stations.
#' 
#' @description Generates a map of RAWS stations given station metadata. This
#' station metadata can be generated by \code{raws_generateMetadata}. Parameters
#' such as \code{radius}, \code{stroke}, \code{color}, \code{opacity}, \code{fillColor}
#' \code{fillOpacity}, and \code{weight} can be passed in to adjust features of
#' the map.
#' 
#' @examples
#' \dontrun{
#' library(RAWSmet)
#' 
#' metadata <- raws_createMetadata("WA")
#' map <- raws_leaflet(metadata)
#' 
#' map
#' }
#' 
#' @rdname raws_leaflet
#' @seealso \code{\link{raws_createMetadata}}
#' @references \href{https://raws.dri.edu/}{RAWS USA Climate Archive}

raws_leaflet <- function(
  metadata = NULL,
  radius = 3.5,
  stroke = TRUE,
  color = 'blue',
  opacity = 0.5,
  fillColor = 'blue',
  fillOpacity = 0.5,
  weight = 1
) {
  
  # ----- Validate parameters --------------------------------------------------
  
  MazamaCoreUtils::stopIfNull(metadata)
  
  requiredNames <- c('stationID', 'siteName', 'longitude', 'latitude', 
                     'elevation', 'countryCode', 'stateCode', 'timezone')
  if( length(names(metadata)) != length(requiredNames) || names(metadata) != requiredNames ) {
    stop("Metadata is not in the format generated raws_createMetadata().")
  }
  
  # ----- Create map  ----------------------------------------------------------
  
  # Create popup text
  metadata$popupText <- paste("<strong>", metadata$siteName, "</strong><br>Station ID:", metadata$stationID, 
                              "<br>Elevation:", metadata$elevation, "m<br>Country Code:", metadata$countryCode, 
                              "<br>State Code:", metadata$stateCode, "<br>Timezone:", metadata$timezone)
  
  map <- leaflet::leaflet(metadata) %>%
    leaflet::addProviderTiles("Esri.WorldTopoMap") %>%
    leaflet::addCircleMarkers(
      lat = ~metadata$latitude,
      lng = ~metadata$longitude,
      popup = ~metadata$popupText,
      radius = ~radius,
      stroke = ~stroke,
      color = ~color,
      opacity = ~opacity,
      fillColor = ~fillColor,
      fillOpacity = ~fillOpacity,
      weight = ~weight
    )
  
  # ----- Return  --------------------------------------------------------------
  
  return(map)
}




